<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billiards League Dashboard</title>
    <style>
        :root {
            --pool-green: #076324;
            --chalk-blue: #0277bd;
            --pocket-black: #1a1a1a;
            --cue-tan: #f3e5ab;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--pool-green); 
            color: white; 
            margin: 0; padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        h1, h2 { text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

        .card {
            background: white; color: #333;
            padding: 20px; margin-bottom: 20px;
            border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        input, select {
            width: 100%; padding: 10px; margin: 8px 0;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; color: white; margin-top: 10px;
        }

        .btn-reg { background-color: var(--chalk-blue); }
        .btn-queue { background-color: #d32f2f; }
        .btn-match { background-color: #ff9800; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        
        .queue-item {
            background: #f1f8e9; margin: 5px 0; padding: 10px;
            border-left: 5px solid var(--pool-green);
            display: flex; justify-content: space-between;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üé± Billiards League Dashboard</h1>

    <div class="grid-layout">
        
        <div class="card">
            <h2>üÜï Player Registration</h2>
            <form id="register-form">
                <input type="text" id="reg-username" placeholder="Username" required>
                <input type="text" id="reg-firstname" placeholder="First Name" required>
                <input type="text" id="reg-lastname" placeholder="Last Name" required>
                <input type="password" id="reg-password" placeholder="Password" required>
                <button type="submit" class="btn-reg">Join League</button>
            </form>
            <p id="reg-msg" style="text-align:center;"></p>
        </div>

        <div class="card">
            <h2>‚è≥ Table 1 Waiting List</h2>
            <form id="join-queue-form">
                <input type="number" id="queue-userid" placeholder="Your User ID" required>
                <select id="queue-tableid"><option value="1">Table 1 (Blue Felt)</option></select>
                <button type="submit" class="btn-queue">Join Queue</button>
            </form>
            <div id="queue-list" style="margin-top:15px;"></div>
        </div>

        <div class="card">
            <h2>üéØ Report Match Score</h2>
            <form id="match-form">
                <label>Player 1 ID</label>
                <input type="number" id="p1-id" placeholder="ID" required>
                <input type="number" id="p1-balls" placeholder="Balls Made" required>
                
                <label>Player 2 ID</label>
                <input type="number" id="p2-id" placeholder="ID" required>
                <input type="number" id="p2-balls" placeholder="Balls Made" required>
                
                <button type="submit" class="btn-match">Submit Match Results</button>
            </form>
            <p id="match-msg" style="text-align:center;"></p>
        </div>

    </div>

    <div class="card">
        <h2>üèÜ Rankings</h2>
        <table>
            <thead>
                <tr>
                    <th>Player</th>
                    <th>ELO</th>
                    <th>Record (W/L)</th>
                    <th>Tier</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>
</div>

<script>
    const API_BASE = "http://127.0.0.1:5000";

    // --- FETCH DATA ---
    async function updateUI() {
        // Fetch Leaderboard
        const lbRes = await fetch(`${API_BASE}/leaderboard`);
        const lbData = await lbRes.json();
        document.getElementById('leaderboard-body').innerHTML = lbData.map(p => `
            <tr>
                <td><strong>${p.username}</strong></td>
                <td>${p.elo_rating}</td>
                <td>${p.total_wins} - ${p.total_losses}</td>
                <td>${p.rank_name}</td>
            </tr>
        `).join('');

        // Fetch Queue
        const qRes = await fetch(`${API_BASE}/queue/1`);
        const qData = await qRes.json();
        document.getElementById('queue-list').innerHTML = qData.map(e => `
            <div class="queue-item"><span><strong>#${e.position}</strong> ${e.username}</span></div>
        `).join('') || "<p>Queue is empty.</p>";
    }

    // --- ACTION: REGISTER ---
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            username: document.getElementById('reg-username').value,
            first_name: document.getElementById('reg-firstname').value,
            last_name: document.getElementById('reg-lastname').value,
            password: document.getElementById('reg-password').value
        };
        const res = await fetch(`${API_BASE}/register`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if(res.ok) { alert("Welcome!"); updateUI(); e.target.reset(); }
    });

    // --- ACTION: JOIN QUEUE ---
    document.getElementById('join-queue-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch(`${API_BASE}/queue/join`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: document.getElementById('queue-userid').value,
                table_id: document.getElementById('queue-tableid').value
            })
        });
        if(res.ok) { updateUI(); e.target.reset(); }
    });

    // --- ACTION: REPORT MATCH ---
    document.getElementById('match-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const p1 = { id: parseInt(document.getElementById('p1-id').value), balls: parseInt(document.getElementById('p1-balls').value) };
        const p2 = { id: parseInt(document.getElementById('p2-id').value), balls: parseInt(document.getElementById('p2-balls').value) };
        
        // Determine Winner and Elo Change (Example: 10 points per ball the winner made)
        let winner_id, loser_id, elo_change;
        
        if (p1.balls > p2.balls) {
            winner_id = p1.id; loser_id = p2.id; elo_change = p1.balls * 10;
        } else {
            winner_id = p2.id; loser_id = p1.id; elo_change = p2.balls * 10;
        }

        const res = await fetch(`${API_BASE}/match/record`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table_id: 1,
                winner_id: winner_id,
                loser_id: loser_id,
                elo_change: elo_change
            })
        });

        if (res.ok) {
            alert("Match recorded! ELO updated.");
            updateUI();
            e.target.reset();
        }
    });

    // Start everything
    updateUI();
    setInterval(updateUI, 10000);
</script>
</body>
</html>